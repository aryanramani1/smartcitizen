<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartCitizen - All-in-One</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* Theme variables */
    :root {
      --brand: #2c5f2d;
      --brand-2: #1e3a1e;
      --accent: #4caf50;
      --accent-2: #45a049;
      --ai-start: #7b2ff7;
      --ai-end: #f107a3;
      --ai-hover-start: #5b1ed9;
      --ai-hover-end: #cf058a;
      --primary: #007bff;
      --danger: #dc3545;
      --warning: #ffc107;
      --bg: #f8f9fa;
      --text: #333;
      --muted: #6c757d;
      --card: #fff;
      --shadow: 0 4px 20px rgba(0,0,0,.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    /* Navbar */
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; padding: 1rem 0; color: #fff; background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); box-shadow: 0 2px 10px rgba(0,0,0,.1); }
    .nav-container { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .nav-brand { display: flex; align-items: center; gap: .5rem; font-weight: 700; font-size: 1.4rem; }
    .nav-brand i { color: #97b498; }
    .nav-menu { display: flex; align-items: center; gap: 1.25rem; }
    .nav-link { color: #fff; text-decoration: none; cursor: pointer; transition: .2s; }
    .nav-link:hover { color: #97b498; }
    .nav-auth, .nav-user { display: flex; align-items: center; gap: .5rem; }
    .hamburger { display: none; flex-direction: column; gap: 4px; cursor: pointer; }
    .hamburger span { width: 24px; height: 3px; background: #fff; }

    /* Buttons */
    .btn-primary, .btn-secondary, .btn-login, .btn-register, .btn-logout, .btn-submit, .btn-ai, .btn-quick {
      display: inline-flex; align-items: center; gap: .5rem; cursor: pointer; border: 0; border-radius: 10px; padding: .75rem 1.25rem; font-weight: 600; transition: transform .15s ease, box-shadow .2s ease, background .2s ease; text-decoration: none;
    }
    .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #fff; box-shadow: 0 8px 20px rgba(76,175,80,.25); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(76,175,80,.35); }
    .btn-secondary { background: transparent; color: var(--accent); border: 2px solid var(--accent); }
    .btn-secondary:hover { background: var(--accent); color: #fff; }
    .btn-login, .btn-register { background: rgba(255,255,255,.12); color: #fff; border: 1px solid rgba(255,255,255,.25); }
    .btn-logout { background: var(--danger); color: #fff; }
    .btn-submit { background: var(--primary); color: #fff; font-size: 1.05rem; flex: 1; }
    .btn-quick { background: #17a2b8; color: #fff; flex: 1; }

    /* Sections */
    .section { display: none; padding: 120px 0 60px; min-height: 100vh; }
    .section.active { display: block; }

    /* Hero & stats */
.hero { position: relative; overflow: hidden; text-align: center; padding: 4.25rem 0 5rem; background: linear-gradient(135deg, #f8f9fa, #eef2f7); border-radius: 20px; margin-bottom: 2.2rem; }
.hero h1 { font-size: 3rem; color: var(--brand); margin-bottom: .5rem; }
.brand-hero { display: flex; align-items: center; justify-content: center; gap: .8rem; margin-bottom: .5rem; }
.brand-icon { width: 64px; height: 64px; border-radius: 16px; display: grid; place-items: center; background: linear-gradient(135deg, #35c759, #2faa4c); color: #fff; box-shadow: 0 10px 24px rgba(53,199,89,.35); }
.brand-icon i { font-size: 28px; }
.brand-title { font-size: 3.2rem; font-weight: 800; letter-spacing: .4px; background: linear-gradient(90deg, #1e3a1e, #35c759); -webkit-background-clip: text; background-clip: text; color: transparent; }
@media (max-width: 768px) { .brand-title { font-size: 2.4rem; } .brand-icon { width: 52px; height: 52px; } }

/* Hero ornaments: animated orbs */
.hero-ornaments { pointer-events: none; }
.orb { position: absolute; filter: blur(12px); opacity: .45; border-radius: 50%; mix-blend-mode: multiply; }
.orb-1 { width: 280px; height: 280px; background: radial-gradient(circle at 30% 30%, #9be7a5, transparent 60%); top: -60px; left: -60px; animation: float1 12s ease-in-out infinite; }
.orb-2 { width: 320px; height: 320px; background: radial-gradient(circle at 70% 30%, #c8e6ff, transparent 60%); top: -80px; right: -80px; animation: float2 14s ease-in-out infinite; }
.orb-3 { width: 240px; height: 240px; background: radial-gradient(circle at 30% 70%, #ffd3f0, transparent 60%); bottom: 0; left: 10%; animation: float3 16s ease-in-out infinite; }
@keyframes float1 { 0%,100% { transform: translateY(0) } 50% { transform: translateY(12px) } }
@keyframes float2 { 0%,100% { transform: translate(0,0) } 50% { transform: translate(-12px,10px) } }
@keyframes float3 { 0%,100% { transform: translateX(0) } 50% { transform: translateX(14px) } }

/* Hero illustration (wave/skyline) */
.hero-illustration { position: absolute; left: 0; right: 0; bottom: -1px; width: 100%; height: 140px; }
.hero-illustration .wave { fill: url(#gradWave); opacity: .9; }
.hero-illustration .city { fill: rgba(44,95,45,.18); }

/* Call-to-action hover */
.hero-buttons .btn-primary, .hero-buttons .btn-secondary { position: relative; }
.hero-buttons .btn-primary::after { content: ""; position: absolute; inset: -1px; border-radius: 12px; background: radial-gradient(600px 200px at 0% 0%, rgba(255,255,255,.35), transparent 40%); opacity: 0; transition: opacity .25s; }
.hero-buttons .btn-primary:hover::after { opacity: 1; }

/* Features grid under stats */
.features-grid { margin-top: 1.8rem; display: grid; grid-template-columns: repeat(4, minmax(220px,1fr)); gap: 1rem; }
.feature-card { position: relative; overflow: hidden; padding: 1.2rem; border-radius: 16px; backdrop-filter: blur(8px); background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(245,248,252,.9)); border: 1px solid rgba(255,255,255,.7); box-shadow: 0 14px 32px rgba(0,0,0,.08); transition: transform .2s, box-shadow .25s; }
.feature-card:hover { transform: translateY(-4px); box-shadow: 0 20px 44px rgba(0,0,0,.12); }
.feature-card .icon { width: 48px; height: 48px; border-radius: 12px; display: grid; place-items: center; color: #fff; margin-bottom: .6rem; box-shadow: 0 10px 20px rgba(0,0,0,.15); }
.icon.green { background: linear-gradient(135deg, #3ad063, #2daa4b); }
.icon.purple { background: linear-gradient(135deg, #7b2ff7, #f107a3); }
.icon.blue { background: linear-gradient(135deg, #4da3ff, #2b7cff); }
.icon.orange { background: linear-gradient(135deg, #ff8c42, #ff5e12); }
.feature-card h4 { font-size: 1.1rem; margin-bottom: .35rem; font-weight: 800; letter-spacing: .2px; }
.feature-card p { color: #5f6b78; font-size: .98rem; }

@media (max-width: 992px) { .features-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 560px) { .features-grid { grid-template-columns: 1fr; } }
    .hero-subtitle { color: #666; font-weight: 600; margin-bottom: .75rem; }
    .hero-description { color: #777; max-width: 680px; margin: 0 auto 1.5rem; }
    .hero-buttons { display: flex; justify-content: center; gap: .75rem; flex-wrap: wrap; }

    .stats-container, .dashboard-stats, .authority-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
    .stat-card { background: var(--card); border-radius: 16px; padding: 1.75rem; box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }
    .stat-card i { color: var(--accent); font-size: 2rem; margin-bottom: .5rem; }
    .stat-card h3 { font-size: 2rem; color: var(--brand); }

    /* Card containers */
    .report-container, .dashboard-content, .authority-content { background: var(--card); border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow); }

    /* Forms */
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; color: #333; margin-bottom: .5rem; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; border: 2px solid #e2e6ea; border-radius: 10px; padding: .75rem; font-size: 1rem; background: #fff; transition: border-color .2s ease, box-shadow .2s ease; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(76,175,80,.15); }
    .form-group input::placeholder, .form-group textarea::placeholder { color: #99a1a8; }

    .photo-upload, .voice-input, .location-input { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; }
    .photo-upload input[type=file] { display: none; }
    #photoPreview img { max-width: 220px; border-radius: 10px; border: 2px solid #e2e6ea; }

    /* AI Button - Custom */
    .btn-ai { position: relative; overflow: hidden; }
    .btn-ai-primary { background: linear-gradient(135deg, var(--ai-start), var(--ai-end)); color: #fff; border: 0; box-shadow: 0 10px 24px rgba(123,47,247,.3); }
    .btn-ai-primary:hover { background: linear-gradient(135deg, var(--ai-hover-start), var(--ai-hover-end)); transform: translateY(-1px); box-shadow: 0 12px 28px rgba(123,47,247,.36); }
    .btn-ai-primary:active { transform: translateY(0); }
    .btn-ai .ai-icon { display: inline-flex; width: 28px; height: 28px; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,.15); }
    .btn-ai .ai-text { font-weight: 700; letter-spacing: .2px; }
    .btn-ai::after { content: ""; position: absolute; top: -50%; left: -20%; width: 60%; height: 200%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 60%); transform: rotate(25deg); transition: .4s; }
    .btn-ai:hover::after { left: -10%; }

    /* AI loading spinner */
    .ai-loading { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,.35); border-top-color: #fff; border-radius: 50%; animation: ai-spin 1s linear infinite; margin-right: .5rem; }
    @keyframes ai-spin { to { transform: rotate(360deg); } }

    .btn-ai[disabled] { opacity: .85; cursor: not-allowed; filter: saturate(.7); }

    /* Map */
    .map-filters { display: flex; align-items: center; gap: .75rem; margin-bottom: .75rem; }
    .map-filters select { padding: .5rem; border: 1px solid #e2e6ea; border-radius: 8px; }

    /* Issues list and badges */
    .issue-item { background: #f8f9fa; border-left: 4px solid var(--accent); border-radius: 12px; padding: 1rem; margin-bottom: .75rem; }
    .issue-header { display: flex; justify-content: space-between; align-items: center; gap: .5rem; margin-bottom: .5rem; }
    .issue-status { padding: .25rem .6rem; border-radius: 999px; font-size: .8rem; font-weight: 700; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-verified, .status-in-progress { background: #cce5ff; color: #004085; }
    .status-resolved { background: #d4edda; color: #155724; }

    .badge-showcase { margin-bottom: 1.25rem; }
    .badges-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: .75rem; }
    .badge-item { background: linear-gradient(135deg, #ffd700, #ffed4e); padding: 1rem; border-radius: 14px; text-align: center; box-shadow: 0 8px 18px rgba(255,215,0,.25); }

    /* Voting */
    .voting-section { background: #f8f9fa; border-radius: 10px; padding: 1rem; border: 2px solid #e9ecef; margin-top: .75rem; }
    .voting-buttons { display: flex; gap: .5rem; margin-top: .5rem; }
    .btn-vote-yes { background: #28a745; color: #fff; }
    .btn-vote-no { background: var(--danger); color: #fff; }
    .vote-results { display: flex; gap: .75rem; margin-top: .4rem; font-weight: 600; }

    /* Modals */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 2000; }
    .modal-content { background: #fff; width: 92%; max-width: 520px; margin: 5% auto; border-radius: 16px; padding: 1.5rem; position: relative; box-shadow: 0 24px 60px rgba(0,0,0,.25); }
    .modal-content.modal-lg { max-width: 840px; }
    .close { position: absolute; right: 16px; top: 12px; font-size: 28px; color: #888; cursor: pointer; }
    .close:hover { color: #000; }

    /* Auth styling enhancements */
    .modal-content h2 { margin-bottom: .5rem; color: var(--brand); }
    .auth-subtext { color: var(--muted); margin-bottom: 1rem; }
    .checkbox-group label { display: flex; align-items: center; gap: .6rem; font-weight: 500; color: #333; }
    .checkbox-group input[type=checkbox] { width: 18px; height: 18px; accent-color: var(--accent); }
    .policy-text { font-size: .95rem; color: var(--muted); margin-top: .75rem; }
    .policy-link { color: var(--accent); text-decoration: underline; }
    .privacy-content h3 { margin: 1rem 0 .5rem; color: var(--brand); }
    .privacy-content p, .privacy-content li { color: #444; line-height: 1.6; }
    .privacy-content ul { padding-left: 1.2rem; }

    /* Notifications */
    .notification-container { position: fixed; top: 84px; right: 18px; z-index: 3000; }
    .notification { background: var(--accent); color: #fff; padding: .9rem 1rem; border-radius: 10px; margin-bottom: .5rem; box-shadow: var(--shadow); animation: slideIn .25s ease; }
    .notification.error { background: var(--danger); }
    .notification.warning { background: var(--warning); color: #333; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Leaderboard */
    .leaderboard { margin-top: 1rem; }
    .podium { display: grid; grid-template-columns: 1fr 1.2fr 1fr; align-items: end; gap: 1rem; margin: 1.2rem 0 1.5rem; }
    .podium-item { position: relative; padding: 1.25rem 1rem; text-align: center; border-radius: 18px; background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,.6); box-shadow: 0 16px 36px rgba(0,0,0,.12); backdrop-filter: blur(10px); }
    .podium-item.first { transform: translateY(-8px); }
    .podium-item .medal { font-size: 1.4rem; margin-bottom: .35rem; }
    .medal.gold { color: #d4af37; text-shadow: 0 0 8px rgba(212,175,55,.35); }
    .medal.silver { color: #c0c0c0; text-shadow: 0 0 8px rgba(192,192,192,.35); }
    .medal.bronze { color: #cd7f32; text-shadow: 0 0 8px rgba(205,127,50,.35); }
    .rank-number { font-size: .9rem; font-weight: 800; color: #6c757d; letter-spacing: .3px; }
    .avatar { width: 64px; height: 64px; border-radius: 50%; margin: .35rem auto; display: grid; place-items: center; color: #fff; font-weight: 800; letter-spacing: .5px; box-shadow: 0 8px 18px rgba(0,0,0,.15); border: 3px solid rgba(255,255,255,.6); }
    .user-name { font-weight: 800; margin-top: .35rem; }
    .user-id { font-size: .85rem; color: #6c757d; }
    .user-metrics { display: flex; justify-content: center; gap: .75rem; margin-top: .35rem; font-weight: 700; }

    .leader-list { background: rgba(255,255,255,.9); border: 1px solid rgba(255,255,255,.6); border-radius: 16px; box-shadow: 0 16px 36px rgba(0,0,0,.08); overflow: hidden; }
    .leader-row { display: grid; grid-template-columns: 60px 1fr 120px 120px; align-items: center; gap: .75rem; padding: .8rem 1rem; border-bottom: 1px solid #eef1f6; }
    .leader-row:last-child { border-bottom: 0; }
    .leader-rank { font-weight: 900; color: #2c5f2d; text-align: center; }
    .leader-who { display: flex; align-items: center; gap: .9rem; }
    .leader-who .avatar { width: 42px; height: 42px; font-size: .85rem; border-width: 2px; }
    .leader-badges, .leader-points { text-align: center; font-weight: 800; }
    .current-user-row { background: linear-gradient(90deg, rgba(53,199,89,.08), transparent); }

    @media (max-width: 768px) {
      .leader-row { grid-template-columns: 44px 1fr 90px 80px; }
      .leader-badges, .leader-points { font-size: .9rem; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hamburger { display: flex; }
      .nav-menu { position: fixed; left: -100%; top: 70px; flex-direction: column; background: var(--brand); width: 100%; text-align: center; transition: .2s; padding: 1.5rem 0; }
      .nav-menu.active { left: 0; }
      .hero h1 { font-size: 2.3rem; }
      .section { padding: 100px 0 40px; }
      .photo-upload, .voice-input, .location-input { flex-direction: column; align-items: stretch; }
    }

    /* Advanced theme overrides */
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, 'Noto Sans', 'Helvetica Neue', sans-serif; }

    /* Background with layered gradients for depth */
    body {
      background:
        radial-gradient(1200px 600px at -10% -10%, #e8f4ea 0%, transparent 40%),
        radial-gradient(900px 600px at 110% -10%, #eaf0ff 0%, transparent 45%),
        linear-gradient(180deg, #fdfefe 0%, #f6f7fb 100%);
    }

    /* Glassmorphism surfaces */
    .stat-card, .report-container, .dashboard-content, .authority-content {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(255,255,255,0.65);
      backdrop-filter: blur(10px) saturate(120%);
    }

    /* Navbar polish */
    .navbar {
      background: linear-gradient(135deg, rgba(44,95,45,0.9), rgba(30,58,30,0.9));
      backdrop-filter: saturate(140%) blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    /* Headings underline */
    .section h2 {
      position: relative;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .section h2::after {
      content: '';
      display: block;
      width: 72px;
      height: 4px;
      margin-top: .5rem;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), #7bda81);
    }

    /* Cards hover microinteraction */
    :where(.stat-card, .report-container, .dashboard-content, .authority-content, .issue-item) {
      transition: transform .2s ease, box-shadow .3s ease, background .3s ease;
    }
    :where(.stat-card, .issue-item):hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(0,0,0,.08); }

    /* Inputs polish */
    .form-group input, .form-group select, .form-group textarea {
      border-radius: 12px;
      border-color: #e4e7ec;
      background: #fff;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(76,175,80,.14);
      background: #fff;
    }

    /* Buttons elevated */
    .btn-primary {
      background: linear-gradient(135deg, #35c759, #2faa4c);
      box-shadow: 0 12px 28px rgba(53,199,89,.28), inset 0 -2px 0 rgba(0,0,0,.08);
      border: 1px solid rgba(255,255,255,.28);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 16px 36px rgba(53,199,89,.34); }

    .btn-secondary {
      border-color: rgba(76,175,80,.65);
      color: #2a7f35;
    }
    .btn-secondary:hover { background: #eaf6ed; color: #216a2c; }

    .btn-submit { box-shadow: 0 12px 28px rgba(0,123,255,.22); }
    .btn-quick  { box-shadow: 0 12px 28px rgba(23,162,184,.22); }

    /* AI button glow */
    .btn-ai-primary {
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: 0 0 0 2px rgba(123,47,247,.18), 0 14px 28px rgba(123,47,247,.32);
    }
    .btn-ai-primary:hover {
      box-shadow: 0 0 0 3px rgba(241,7,163,.18), 0 18px 36px rgba(123,47,247,.4);
    }

    /* Maps polish */
    #mainMap, #locationMap {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 16px 36px rgba(0,0,0,.12);
      border: 1px solid #e6e9ef;
    }

    /* Modals depth */
    .modal-content {
      background: linear-gradient(180deg, #ffffff, #f9fbff);
      border: 1px solid #eef1f6;
      box-shadow: 0 30px 70px rgba(0,0,0,.18);
    }

    /* Notifications punchy */
    .notification {
      border: 1px solid rgba(255,255,255,.2);
      box-shadow: 0 16px 40px rgba(0,0,0,.14);
      font-weight: 600;
      letter-spacing: .2px;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root { --bg: #0f1216; --text: #e7ebf0; }
      body { background: radial-gradient(1200px 600px at -10% -10%, #102015 0%, transparent 40%), radial-gradient(900px 600px at 110% -10%, #0e1a2b 0%, transparent 45%), linear-gradient(180deg, #101418, #0b0f14); color: var(--text); }
      .stat-card, .report-container, .dashboard-content, .authority-content { background: rgba(17,22,28,.65); border-color: rgba(255,255,255,.06); }
      .navbar { background: linear-gradient(135deg, rgba(44,95,45,0.35), rgba(30,58,30,0.35)); border-bottom-color: rgba(255,255,255,.06); }
      .form-group input, .form-group select, .form-group textarea { background: #141a21; border-color: #243142; color: #dfe6ee; }
      .form-group input::placeholder, .form-group textarea::placeholder { color: #8aa0b5; }
      .modal-content { background: linear-gradient(180deg, #121821, #0f141c); border-color: #1e2a3a; }
      .notification.warning { color: #1a1f24; }
    }

  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand"><i class="fas fa-city"></i><span>SmartCitizen</span></div>
      <div class="nav-menu" id="navMenu">
        <a href="#home" class="nav-link">Home</a>
        <a href="#report" class="nav-link">Report Issue</a>
        <a href="#map" class="nav-link">Map</a>
        <a href="#dashboard" class="nav-link">Dashboard</a>
        <a href="#authority" class="nav-link" id="authorityLink" style="display:none;">Authority</a>
        <div class="nav-auth" id="authButtons">
          <button class="btn-login" onclick="showLogin()">Login</button>
          <button class="btn-register" onclick="showRegister()">Register</button>
        </div>
        <div class="nav-user" id="userInfo" style="display:none;">
          <span id="userGreeting"></span>
          <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
      </div>
      <div class="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></div>
    </div>
  </nav>

  <!-- Home -->
  <section id="home" class="section active">
    <div class="container">
      <div class="hero">
        <div class="hero-ornaments">
          <span class="orb orb-1"></span>
          <span class="orb orb-2"></span>
          <span class="orb orb-3"></span>
        </div>
        <div class="brand-hero">
          <div class="brand-icon"><i class="fas fa-city"></i></div>
          <h1 class="brand-title">SmartCitizen</h1>
        </div>
        <p class="hero-subtitle">AI-Powered Civic Issue Reporting Platform</p>
        <p class="hero-description">Report civic issues in your community with AI assistance. Get quick responses from authorities and earn rewards for active participation.</p>
        <div class="hero-buttons">
          <button class="btn-primary" onclick="showSection('report')">Report an Issue</button>
          <button class="btn-secondary" onclick="showSection('map')">View Issues Map</button>
        </div>
        <svg class="hero-illustration" viewBox="0 0 1440 320" preserveAspectRatio="none" aria-hidden="true">
          <defs>
            <linearGradient id="gradWave" x1="0" x2="1" y1="0" y2="0">
              <stop offset="0%" stop-color="#e8f5e9" />
              <stop offset="100%" stop-color="#e3f2fd" />
            </linearGradient>
          </defs>
          <path class="wave" d="M0,224L80,197.3C160,171,320,117,480,101.3C640,85,800,107,960,133.3C1120,160,1280,192,1360,208L1440,224L1440,320L1360,320C1280,320,1120,320,960,320C800,320,640,320,480,320C320,320,160,320,80,320L0,320Z"></path>
        </svg>
      </div>
    <div class="stats-container">
        <div class="stat-card"><i class="fas fa-exclamation-triangle"></i><h3 id="totalReports">0</h3><p>Total Reports</p></div>
        <div class="stat-card"><i class="fas fa-check-circle"></i><h3 id="resolvedReports">0</h3><p>Resolved</p></div>
        <div class="stat-card"><i class="fas fa-users"></i><h3 id="activeUsers">0</h3><p>Active Citizens</p></div>
      </div>

      <div class="features-grid">
        <div class="feature-card">
          <div class="icon green"><i class="fas fa-wand-magic-sparkles"></i></div>
          <h4>AI Hindi Description</h4>
          <p>Photo or voice to short, accurate Hindi text—no typing needed.</p>
        </div>
        <div class="feature-card">
          <div class="icon blue"><i class="fas fa-bolt"></i></div>
          <h4>7‑Second Reporting</h4>
          <p>Quick Submit auto‑fills the essentials so you can report instantly.</p>
        </div>
        <div class="feature-card">
          <div class="icon purple"><i class="fas fa-users-verify"></i></div>
          <h4>Community Verified</h4>
          <p>Local users vote Yes/No to surface real issues and reduce spam.</p>
        </div>
        <div class="feature-card">
          <div class="icon orange"><i class="fas fa-clipboard-check"></i></div>
          <h4>Authority Workflow</h4>
          <p>Verified issues go to the authority queue with In‑Progress/Resolved.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Report -->
  <section id="report" class="section">
    <div class="container">
      <h2>Report a Civic Issue</h2>
      <div class="report-container">
        <div class="report-form">
          <div class="form-group">
            <label>Issue Category</label>
            <select id="issueCategory" required>
              <option value="">Select Category</option>
              <option value="road">Road & Infrastructure</option>
              <option value="water">Water & Drainage</option>
              <option value="electricity">Electricity</option>
              <option value="garbage">Garbage & Sanitation</option>
              <option value="traffic">Traffic & Parking</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label>Add Photo of Issue</label>
            <div class="photo-upload">
              <input type="file" id="photoInput" accept="image/*" capture="environment" />
              <button type="button" onclick="document.getElementById('photoInput').click()" class="btn-secondary"><i class="fas fa-camera"></i> Take Photo</button>
              <div id="photoPreview"></div>
            </div>
          </div>

          <div class="form-group">
            <label>Voice Description (Optional)</label>
            <div class="voice-input">
              <button type="button" id="voiceBtn" onclick="toggleVoiceRecording()" class="btn-secondary"><i class="fas fa-microphone"></i> <span id="voiceStatus">Start Recording</span></button>
              <div id="voicePreview"></div>
            </div>
          </div>

          <div class="form-group">
            <label>Issue Description</label>
            <textarea id="issueDescription" rows="4" placeholder="Describe the issue or let AI generate description from photo/voice..."></textarea>
            <button type="button" id="aiBtn" class="btn-ai btn-ai-primary" title="Generate Hindi description with AI" onclick="generateAIDescription()">
              <span class="ai-icon"><i class="fas fa-wand-magic-sparkles"></i></span>
              <span class="ai-text">Generate Hindi Description</span>
            </button>
          </div>

          <div class="form-group">
            <label>Location</label>
            <div class="location-input">
              <input type="text" id="locationText" placeholder="Location will be auto-detected..." readonly />
              <button type="button" class="btn-secondary" onclick="getCurrentLocation()"><i class="fas fa-location-arrow"></i> Get Location</button>
            </div>
            <div id="locationMap" style="height: 220px; margin-top: 10px;"></div>
          </div>

          <div class="quick-actions">
            <button type="button" class="btn-quick" onclick="quickSubmit()"><i class="fas fa-bolt"></i> Quick Submit (Auto-fill)</button>
            <button type="button" class="btn-submit" onclick="submitIssue()"><i class="fas fa-paper-plane"></i> Submit Report</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Map -->
  <section id="map" class="section">
    <div class="container">
      <h2>Issues Map</h2>
      <div class="map-filters">
        <select id="mapFilter">
          <option value="all">All Issues</option>
          <option value="pending">Pending</option>
          <option value="in-progress">In Progress</option>
          <option value="resolved">Resolved</option>
        </select>
        <button class="btn-secondary" onclick="refreshMap()"><i class="fas fa-sync-alt"></i> Refresh</button>
      </div>
      <div id="mainMap" style="height: 500px; width: 100%;"></div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="section">
    <div class="container">
      <h2>Your Dashboard</h2>
      <div class="dashboard-content">
        <div class="dashboard-stats">
          <div class="stat-card"><i class="fas fa-file-alt"></i><h3 id="userReports">0</h3><p>Your Reports</p></div>
          <div class="stat-card"><i class="fas fa-star"></i><h3 id="userPoints">0</h3><p>Reputation Points</p></div>
          <div class="stat-card"><i class="fas fa-award"></i><h3 id="userBadges">0</h3><p>Badges Earned</p></div>
        </div>
        <div class="badge-showcase" id="badgeShowcase">
          <h3>Your Badges</h3>
          <div class="badges-grid" id="badgesContainer"></div>
        </div>
        <div class="recent-reports">
          <h3>Your Recent Reports</h3>
          <div id="userReportsList"></div>
        </div>

        <div class="leaderboard-block" style="margin-top:1.25rem;">
          <h3>Community Leaderboard</h3>
          <p class="auth-subtext">Top SmartCitizens ranked by total badges, then reputation points.</p>
          <div class="leaderboard">
            <div class="podium" id="leaderPodium"></div>
            <div class="leader-list" id="leaderList"></div>
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- Authority -->
  <section id="authority" class="section">
    <div class="container">
      <h2>Authority Dashboard</h2>
      <div class="authority-content">
        <div class="authority-stats">
          <div class="stat-card"><i class="fas fa-exclamation-circle"></i><h3 id="pendingIssues">0</h3><p>Pending Issues</p></div>
          <div class="stat-card"><i class="fas fa-cog"></i><h3 id="inProgressIssues">0</h3><p>In Progress</p></div>
          <div class="stat-card"><i class="fas fa-check"></i><h3 id="resolvedIssues">0</h3><p>Resolved</p></div>
        </div>
        <div class="issues-list">
          <h3>Verified Issues Requiring Action</h3>
          <div id="authorityIssuesList"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('loginModal')">&times;</span>
      <h2>Login</h2>
      <p class="auth-subtext">Welcome back! Please enter your credentials to continue.</p>
      <form onsubmit="login(event)">
        <div class="form-group">
          <label>Email or Phone</label>
          <input type="text" id="loginEmail" placeholder="Enter email or phone" required />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password" required />
        </div>
        <button type="submit" class="btn-primary">Login</button>
      </form>
      <p class="policy-text">By logging in, you agree to our <a href="#" class="policy-link" onclick="showPrivacyPolicy()">Privacy Policy</a>.</p>
      <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('registerModal')">&times;</span>
      <h2>Register</h2>
      <p class="auth-subtext">Create your SmartCitizen account to report and track civic issues.</p>
      <form onsubmit="register(event)">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="registerName" placeholder="Your full name" required />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="registerEmail" placeholder="you@example.com" required />
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="registerPhone" placeholder="+91XXXXXXXXXX" required />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="registerPassword" placeholder="Choose a strong password" required />
        </div>
        <div class="form-group checkbox-group">
          <label><input type="checkbox" id="isAuthority" /> I am a local authority</label>
        </div>
        <div class="form-group checkbox-group">
          <label><input type="checkbox" id="agreePrivacy" /> I agree to the <a href="#" class="policy-link" onclick="showPrivacyPolicy()">Privacy Policy</a></label>
        </div>
        <button type="submit" class="btn-primary">Register</button>
      </form>
      <p class="policy-text">We respect your privacy. Your data is used only to improve community services.</p>
      <p>Already have an account? <a href="#" onclick="showLogin()">Login here</a></p>
    </div>
  </div>

  <!-- Issue Detail Modal -->
  <div id="issueModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('issueModal')">&times;</span>
      <div id="issueModalContent"></div>
    </div>
  </div>

  <!-- Privacy Policy Modal -->
  <div id="privacyModal" class="modal">
    <div class="modal-content modal-lg">
      <span class="close" onclick="closeModal('privacyModal')">&times;</span>
      <h2>Privacy Policy</h2>
      <div class="privacy-content">
        <p>Last updated: September 25, 2025</p>
        <p>SmartCitizen collects limited information to help you report civic issues efficiently and to notify your community and local authorities about progress.</p>
        <h3>What we collect</h3>
        <ul>
          <li>Account info (name, email, phone) to verify your identity</li>
          <li>Issue data (photos, voice notes, descriptions)</li>
          <li>Location (only when you choose to share it for an issue)</li>
          <li>Usage data (votes, badges) to power community features</li>
        </ul>
        <h3>How we use your data</h3>
        <ul>
          <li>To create and manage your account</li>
          <li>To share issue details with local authorities and nearby users</li>
          <li>To prevent spam and improve community verification</li>
          <li>To send status updates on issues you've reported or follow</li>
        </ul>
        <h3>Your choices</h3>
        <ul>
          <li>You control whether to share location for each report</li>
          <li>You can edit or remove your reports stored locally</li>
          <li>You may request data export or deletion by contacting support</li>
        </ul>
        <h3>Data storage</h3>
        <p>This demo stores data in your browser (LocalStorage). In production, data would be stored securely on servers with appropriate safeguards.</p>
        <h3>Contact</h3>
        <p>For privacy questions, email: privacy@smartcitizen.example</p>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notificationContainer" class="notification-container"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Globals
    let currentUser = null;
    let currentLocation = null;
    let locationMap = null;
    let mainMap = null;
    let isRecording = false;
    let recognition = null;

    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      if (!localStorage.getItem('smartcitizen_users')) generateDemoData();
    });

    function initializeApp() {
      const savedUser = localStorage.getItem('smartcitizen_user');
      if (savedUser) { currentUser = JSON.parse(savedUser); updateAuthUI(); }

      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'hi-IN';
        recognition.onresult = (e) => {
          const transcript = e.results[0][0].transcript;
          document.getElementById('voicePreview').innerHTML = `<p><strong>Recorded:</strong> ${transcript}</p>`;
          translateAndAddToDescription(transcript);
        };
        recognition.onerror = (e) => showNotification('Voice recognition error: ' + e.error, 'error');
      }

      initializeNavigation();
      updateStats();
      setupPhotoHandler();
      setupMapInitialization();
    }

    function initializeNavigation() {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          const href = link.getAttribute('href');
          if (href && href.startsWith('#')) { e.preventDefault(); showSection(href.substring(1)); }
        });
      });
    }

    function showSection(sectionName) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const target = document.getElementById(sectionName); if (target) target.classList.add('active');
      if (sectionName === 'map' && !mainMap) setTimeout(initializeMainMap, 100);
      if (sectionName === 'report' && !locationMap) setTimeout(initializeLocationMap, 100);
      if (sectionName === 'dashboard') {
        if (currentUser) loadUserDashboard();
        loadBadgesLeaderboard();
      }
      if (sectionName === 'authority' && currentUser?.isAuthority) loadAuthorityDashboard();
      document.getElementById('navMenu').classList.remove('active');
    }

    function toggleMenu() { document.getElementById('navMenu').classList.toggle('active'); }

    // Auth
    function showLogin() { closeModal('registerModal'); document.getElementById('loginModal').style.display = 'block'; }
    function showRegister() { closeModal('loginModal'); document.getElementById('registerModal').style.display = 'block'; }
    function showPrivacyPolicy() { document.getElementById('privacyModal').style.display = 'block'; }
    function closeModal(id) { const el = document.getElementById(id); if (el) el.style.display = 'none'; }

    function login(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const users = JSON.parse(localStorage.getItem('smartcitizen_users') || '[]');
      const user = users.find(u => (u.email === email || u.phone === email) && u.password === password);
      if (!user) return showNotification('Invalid credentials. Try: authority@demo.com / demo123', 'error');
      currentUser = user; localStorage.setItem('smartcitizen_user', JSON.stringify(user)); updateAuthUI(); closeModal('loginModal'); showNotification('Welcome back, ' + user.name + '!');
    }

    function register(e) {
      e.preventDefault();
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const phone = document.getElementById('registerPhone').value;
      const password = document.getElementById('registerPassword').value;
      const isAuthority = document.getElementById('isAuthority').checked;
      const agreeEl = document.getElementById('agreePrivacy'); const agreed = agreeEl ? agreeEl.checked : false;
      if (!name || !email || !phone || !password) return showNotification('Please fill in all required fields', 'warning');
      if (!agreed) return showNotification('Please agree to the Privacy Policy to continue', 'warning');
      const userId = 'SC' + Date.now().toString(36) + Math.random().toString(36).slice(2);
      const newUser = { id: userId, name, email, phone, password, isAuthority, reputationPoints: 0, badges: [], joinDate: new Date().toISOString() };
      const users = JSON.parse(localStorage.getItem('smartcitizen_users') || '[]');
      if (users.some(u => u.email === email || u.phone === phone)) return showNotification('User with this email or phone already exists', 'error');
      users.push(newUser); localStorage.setItem('smartcitizen_users', JSON.stringify(users)); currentUser = newUser; localStorage.setItem('smartcitizen_user', JSON.stringify(newUser)); updateAuthUI(); closeModal('registerModal'); showNotification('Registration successful! Welcome to SmartCitizen, ' + name + '!');
    }

    function logout() { currentUser = null; localStorage.removeItem('smartcitizen_user'); updateAuthUI(); showSection('home'); showNotification('Logged out successfully'); }

    function updateAuthUI() {
      const authButtons = document.getElementById('authButtons');
      const userInfo = document.getElementById('userInfo');
      const userGreeting = document.getElementById('userGreeting');
      const authorityLink = document.getElementById('authorityLink');
      if (currentUser) {
        authButtons.style.display = 'none'; userInfo.style.display = 'flex'; userGreeting.textContent = `Hello, ${currentUser.name}`; authorityLink.style.display = currentUser.isAuthority ? 'block' : 'none';
      } else { authButtons.style.display = 'flex'; userInfo.style.display = 'none'; authorityLink.style.display = 'none'; }
    }

    // Photo
    function setupPhotoHandler() {
      const input = document.getElementById('photoInput');
      input.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => { document.getElementById('photoPreview').innerHTML = `<img src="${ev.target.result}" alt="Issue photo" />`; };
        reader.readAsDataURL(file);
      });
    }

    // Voice
    function toggleVoiceRecording() {
      const btn = document.getElementById('voiceBtn'); const status = document.getElementById('voiceStatus');
      if (!isRecording) { startVoiceRecording(); btn.classList.add('voice-recording'); status.textContent = 'Recording... Click to stop'; isRecording = true; }
      else { stopVoiceRecording(); btn.classList.remove('voice-recording'); status.textContent = 'Start Recording'; isRecording = false; }
    }
    function startVoiceRecording() { if (recognition) recognition.start(); else showNotification('Speech recognition not supported in this browser', 'warning'); }
    function stopVoiceRecording() { if (recognition) recognition.stop(); }

    // AI
    async function generateAIDescription() {
      const btn = document.getElementById('aiBtn') || document.querySelector('.btn-ai');
      const original = btn.innerHTML; btn.innerHTML = `<span class="ai-loading"></span>Generating in Hindi...`; btn.disabled = true;
      try {
        await new Promise(r => setTimeout(r, 1200));
        const category = document.getElementById('issueCategory').value;
        const photo = document.getElementById('photoPreview').innerHTML;
        const voice = document.getElementById('voicePreview').innerHTML;
        const description = generateMockAIDescription(category, photo, voice);
        const hindi = await mockTranslateToHindi(description);
        document.getElementById('issueDescription').value = hindi;
        showNotification('AI description generated successfully!');
      } catch { showNotification('Failed to generate AI description', 'error'); }
      finally { btn.innerHTML = `<span class=\"ai-icon\"><i class=\"fas fa-wand-magic-sparkles\"></i></span><span class=\"ai-text\">Generate Hindi Description</span>`; btn.disabled = false; }
    }

    function generateMockAIDescription(category, hasPhoto, hasVoice) {
      const base = {
        road: 'Road damage with potholes affecting vehicle movement',
        water: 'Water leakage or drainage blockage requiring immediate attention',
        electricity: 'Electrical fault or power outage in the area',
        garbage: 'Garbage accumulation or improper waste disposal',
        traffic: 'Traffic congestion or parking violation',
        other: 'Civic issue requiring local authority intervention'
      };
      let text = base[category] || base.other;
      if (hasPhoto) text += '. Photo evidence attached showing the current situation';
      if (hasVoice) text += '. Additional voice description provided by the reporter';
      return text;
    }

    async function mockTranslateToHindi(text) {
      const map = {
        'Road damage with potholes affecting vehicle movement': 'सड़क में गड्ढे हैं जो वाहनों की आवाजाही में बाधा डाल रहे हैं',
        'Water leakage or drainage blockage requiring immediate attention': 'पानी का रिसाव या नाली में रुकावट है जिस पर तुरंत ध्यान देने की जरूरत है',
        'Electrical fault or power outage in the area': 'क्षेत्र में बिजली की खराबी या बिजली कटौती है',
        'Garbage accumulation or improper waste disposal': 'कूड़े का संचय या अनुचित कचरा निपटान',
        'Traffic congestion or parking violation': 'यातायात जाम या पार्किंग का उल्लंघन',
        'Civic issue requiring local authority intervention': 'नागरिक समस्या जिसमें स्थानीय प्राधिकरण के हस्तक्षेप की आवश्यकता है'
      };
      return map[text.split('.')[0]] || 'नागरिक समस्या की रिपोर्ट';
    }

    async function translateAndAddToDescription(voiceText) {
      const hindi = await mockTranslateToHindi(voiceText);
      const current = document.getElementById('issueDescription').value;
      const next = current ? `${current}\n\nआवाज़ से: ${hindi}` : `आवाज़ से: ${hindi}`;
      document.getElementById('issueDescription').value = next;
    }

    // Location & maps
    function getCurrentLocation() {
      if (!navigator.geolocation) return showNotification('Geolocation is not supported by this browser', 'error');
      navigator.geolocation.getCurrentPosition((pos) => {
        currentLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
        document.getElementById('locationText').value = `Lat: ${currentLocation.latitude.toFixed(6)}, Lng: ${currentLocation.longitude.toFixed(6)}`;
        if (locationMap) updateLocationMap(); else initializeLocationMap();
        showNotification('Location detected successfully');
      }, (err) => showNotification('Error getting location: ' + err.message, 'error'));
    }

    function initializeLocationMap() {
      const el = document.getElementById('locationMap'); if (!el) return;
      const lat = currentLocation?.latitude ?? 28.6139; const lng = currentLocation?.longitude ?? 77.2090;
      locationMap = L.map('locationMap').setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(locationMap);
      if (currentLocation) L.marker([lat, lng]).addTo(locationMap).bindPopup('Your current location').openPopup();
    }

    function updateLocationMap() {
      if (!locationMap || !currentLocation) return;
      locationMap.setView([currentLocation.latitude, currentLocation.longitude], 15);
      locationMap.eachLayer(layer => { if (layer instanceof L.Marker) locationMap.removeLayer(layer); });
      L.marker([currentLocation.latitude, currentLocation.longitude]).addTo(locationMap).bindPopup('Your current location').openPopup();
    }

    function initializeMainMap() {
      const el = document.getElementById('mainMap'); if (!el) return;
      mainMap = L.map('mainMap').setView([28.6139, 77.2090], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(mainMap);
      loadIssuesOnMap();
    }

    function loadIssuesOnMap() {
      if (!mainMap) return;
      const issues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]');
      issues.forEach(issue => {
        if (!issue.location) return;
        const marker = L.marker([issue.location.latitude, issue.location.longitude]).addTo(mainMap);
        const popup = `
          <div class="issue-popup">
            <h4>${issue.category}</h4>
            <p><strong>Status:</strong> <span class="issue-status status-${issue.status}">${issue.status}</span></p>
            <p><strong>Description:</strong> ${issue.description.substring(0, 100)}...</p>
            <p><strong>Reported by:</strong> ${issue.reporterName}</p>
            <p><strong>Date:</strong> ${new Date(issue.timestamp).toLocaleDateString()}</p>
            <div class="voting-section">
              <p><strong>Community Votes:</strong></p>
              <div class="vote-results"><span>👍 ${issue.votes?.yes ?? 0}</span><span>👎 ${issue.votes?.no ?? 0}</span></div>
              ${currentUser && !(issue.votes?.voters?.includes(currentUser.id)) ?
                `<div class="voting-buttons">
                  <button class="btn-vote-yes" onclick="voteOnIssue('${issue.id}', true)">Verify</button>
                  <button class="btn-vote-no" onclick="voteOnIssue('${issue.id}', false)">Report Fake</button>
                </div>` : ''}
            </div>
          </div>`;
        marker.bindPopup(popup);
      });
    }

    function refreshMap() { if (!mainMap) return; mainMap.eachLayer(l => { if (l instanceof L.Marker) mainMap.removeLayer(l); }); loadIssuesOnMap(); }
    function getStatusColor(status) { return status === 'pending' ? 'orange' : status === 'in-progress' ? 'blue' : status === 'resolved' ? 'green' : 'red'; }

    // Submit
    function submitIssue() {
      if (!currentUser) { showNotification('Please login to submit an issue', 'warning'); showLogin(); return; }
      const category = document.getElementById('issueCategory').value;
      const description = document.getElementById('issueDescription').value;
      if (!category || !description) return showNotification('Please fill in all required fields', 'warning');
      if (!currentLocation) return showNotification('Please get your location first', 'warning');
      const photo = document.getElementById('photoInput').files[0];
      const issue = {
        id: 'ISSUE_' + Date.now().toString(36), category, description, location: currentLocation,
        reporterId: currentUser.id, reporterName: currentUser.name, timestamp: new Date().toISOString(),
        status: 'pending', votes: { yes: 0, no: 0, voters: [] }, photo: photo ? URL.createObjectURL(photo) : null
      };
      const issues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]'); issues.push(issue);
      localStorage.setItem('smartcitizen_issues', JSON.stringify(issues));
      currentUser.reputationPoints += 10; awardBadgeIfEligible('reporter'); updateUserInStorage();
      document.getElementById('issueCategory').value = '';
      document.getElementById('issueDescription').value = '';
      document.getElementById('photoPreview').innerHTML = '';
      document.getElementById('voicePreview').innerHTML = '';
      document.getElementById('photoInput').value = '';
      showNotification('Issue submitted successfully! You earned 10 reputation points.');
      updateStats();
    }

    function quickSubmit() {
      if (!currentUser) { showNotification('Please login to submit an issue', 'warning'); showLogin(); return; }
      const category = document.getElementById('issueCategory').value || 'other';
      if (!category) document.getElementById('issueCategory').value = 'other';
      if (!currentLocation) { getCurrentLocation(); return setTimeout(() => currentLocation ? proceedWithQuickSubmit() : showNotification('Location required for quick submit', 'warning'), 1800); }
      proceedWithQuickSubmit();
    }

    function proceedWithQuickSubmit() {
      const category = document.getElementById('issueCategory').value || 'other';
      const map = { road: 'सड़क में समस्या है जिसे तुरंत ठीक करने की जरूरत है', water: 'पानी या नाली की समस्या है', electricity: 'बिजली की समस्या है', garbage: 'कूड़े की समस्या है', traffic: 'यातायात की समस्या है', other: 'नागरिक समस्या है जिस पर ध्यान देना आवश्यक है' };
      if (!document.getElementById('issueDescription').value) document.getElementById('issueDescription').value = map[category] || map.other;
      submitIssue();
      showNotification('⚡ Quick submit completed in under 7 seconds!', 'success');
    }

    // Voting & badges
    function voteOnIssue(id, approve) {
      if (!currentUser) return showNotification('Please login to vote', 'warning');
      const issues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]');
      const idx = issues.findIndex(i => i.id === id); if (idx === -1) return showNotification('Issue not found', 'error');
      const issue = issues[idx];
      if (issue.votes.voters.includes(currentUser.id)) return showNotification('You have already voted on this issue', 'warning');
      approve ? issue.votes.yes++ : issue.votes.no++; issue.votes.voters.push(currentUser.id);
      if (issue.votes.yes >= 3 && issue.status === 'pending') { issue.status = 'verified'; showNotification('Issue has been verified by the community!'); }
      currentUser.reputationPoints += 2; awardBadgeIfEligible('voter'); updateUserInStorage();
      localStorage.setItem('smartcitizen_issues', JSON.stringify(issues)); refreshMap(); showNotification('Thank you for your vote! You earned 2 reputation points.');
    }

    function awardBadgeIfEligible(type) {
      const badges = { reporter: { threshold: 1, name: 'First Reporter', icon: 'fas fa-flag' }, voter: { threshold: 5, name: 'Community Voter', icon: 'fas fa-vote-yea' }, active: { threshold: 50, name: 'Active Citizen', icon: 'fas fa-star' }, expert: { threshold: 100, name: 'Civic Expert', icon: 'fas fa-trophy' } };
      const badge = badges[type]; if (!badge) return;
      const myIssues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]').filter(i => i.reporterId === currentUser.id);
      const ok = type === 'reporter' ? myIssues.length >= badge.threshold : type === 'voter' ? currentUser.reputationPoints >= badge.threshold * 2 : currentUser.reputationPoints >= badge.threshold;
      if (ok && !currentUser.badges.some(b => b.type === type)) { currentUser.badges.push({ type, name: badge.name, icon: badge.icon, earnedDate: new Date().toISOString() }); showNotification(`🏆 Badge Unlocked: ${badge.name}!`); updateUserInStorage(); }
    }

    function updateUserInStorage() {
      localStorage.setItem('smartcitizen_user', JSON.stringify(currentUser));
      const users = JSON.parse(localStorage.getItem('smartcitizen_users') || '[]');
      const idx = users.findIndex(u => u.id === currentUser.id); if (idx !== -1) { users[idx] = currentUser; localStorage.setItem('smartcitizen_users', JSON.stringify(users)); }
    }

    // Dashboards
    function loadUserDashboard() {
      if (!currentUser) return; const issues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]'); const mine = issues.filter(i => i.reporterId === currentUser.id);
      document.getElementById('userReports').textContent = mine.length;
      document.getElementById('userPoints').textContent = currentUser.reputationPoints;
      document.getElementById('userBadges').textContent = currentUser.badges.length;
      const badgesContainer = document.getElementById('badgesContainer'); badgesContainer.innerHTML = '';
      currentUser.badges.forEach(b => { const el = document.createElement('div'); el.className = 'badge-item'; el.innerHTML = `<i class="${b.icon}"></i><span>${b.name}</span>`; badgesContainer.appendChild(el); });
      const list = document.getElementById('userReportsList'); list.innerHTML = '';
      mine.slice(-5).reverse().forEach(issue => { const el = document.createElement('div'); el.className = 'issue-item'; el.innerHTML = `
        <div class="issue-header"><h4>${issue.category}</h4><span class="issue-status status-${issue.status}">${issue.status}</span></div>
        <p>${issue.description}</p><p><small>Reported on: ${new Date(issue.timestamp).toLocaleString()}</small></p>
        <div class="vote-results"><span>👍 ${issue.votes.yes}</span><span>👎 ${issue.votes.no}</span></div>`; list.appendChild(el); });
    }

    function loadBadgesLeaderboard() {
      const containerPodium = document.getElementById('leaderPodium');
      const listEl = document.getElementById('leaderList');
      if (!containerPodium || !listEl) return;
      const users = getLeaderboardUsers();
      containerPodium.innerHTML = '';
      listEl.innerHTML = '';

      if (!users.length) {
        listEl.innerHTML = '<div class="leader-row"><div class="leader-who">No users yet. Be the first to earn badges!</div></div>';
        return;
      }

      // Top 3 on podium
      const top3 = users.slice(0,3);
      const podiumHtml = [
        podiumItemHtml(top3[1], 2, 'second'),
        podiumItemHtml(top3[0], 1, 'first'),
        podiumItemHtml(top3[2], 3, 'third')
      ].join('');
      containerPodium.innerHTML = podiumHtml;

      // Ranks 4 - 20 list
      const rest = users.slice(3, 20);
      rest.forEach((u, idx) => {
        const rank = idx + 4;
        const isMe = currentUser && u.id === currentUser.id;
        const row = document.createElement('div');
        row.className = 'leader-row' + (isMe ? ' current-user-row' : '');
        row.innerHTML = `
          <div class="leader-rank">${rank}</div>
          <div class="leader-who">
            ${avatarHtml(u)}
            <div>
              <div class="user-name">${escapeHtml(u.name || u.id)}</div>
              <div class="user-id">${u.id}</div>
            </div>
          </div>
          <div class="leader-badges">🏅 ${u.badgesCount}</div>
          <div class="leader-points">⭐ ${u.reputationPoints}</div>
        `;
        listEl.appendChild(row);
      });
    }

    function getLeaderboardUsers() {
      const users = JSON.parse(localStorage.getItem('smartcitizen_users') || '[]');
      // map to computed fields
      const enriched = users.map(u => ({
        id: u.id,
        name: u.name,
        badgesCount: Array.isArray(u.badges) ? u.badges.length : 0,
        reputationPoints: typeof u.reputationPoints === 'number' ? u.reputationPoints : 0,
        joinDate: u.joinDate || '2099-01-01T00:00:00.000Z'
      }));
      enriched.sort((a,b) => {
        if (b.badgesCount !== a.badgesCount) return b.badgesCount - a.badgesCount;
        if (b.reputationPoints !== a.reputationPoints) return b.reputationPoints - a.reputationPoints;
        return new Date(a.joinDate) - new Date(b.joinDate);
      });
      return enriched;
    }

    function podiumItemHtml(user, rank, cls) {
      if (!user) return `<div class="podium-item ${cls}"><div class="rank-number">${rank}</div><div class="user-name">—</div></div>`;
      const medalClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : 'bronze';
      const me = currentUser && user.id === currentUser.id ? ' (You)' : '';
      return `
        <div class="podium-item ${cls}">
          <div class="rank-number">RANK ${rank}</div>
          <div class="medal ${medalClass}">${rank === 1 ? '👑' : '🏅'}</div>
          ${avatarHtml(user)}
          <div class="user-name">${escapeHtml(user.name || user.id)}${me}</div>
          <div class="user-id">${user.id}</div>
          <div class="user-metrics"><span>🏅 ${user.badgesCount}</span> <span>⭐ ${user.reputationPoints}</span></div>
        </div>`;
    }

    function avatarHtml(user) {
      const initials = getInitials(user.name || user.id);
      const hue = Math.abs(hashCode(user.id)) % 360;
      const bg = `linear-gradient(135deg, hsl(${hue}, 80%, 55%), hsl(${(hue+40)%360}, 75%, 50%))`;
      return `<div class="avatar" style="background: ${bg}">${escapeHtml(initials)}</div>`;
    }

    function getInitials(name) {
      const parts = String(name).trim().split(/\s+/).slice(0,2);
      return parts.map(p => p[0]?.toUpperCase() || '').join('');
    }

    function hashCode(str) {
      let h = 0; for (let i=0;i<str.length;i++){ h = ((h<<5)-h) + str.charCodeAt(i); h |= 0; }
      return h;
    }

    function escapeHtml(s) {
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'};
      return String(s).replace(/[&<>\"']/g, ch => map[ch]);
    }

    function loadAuthorityDashboard() {
      if (!currentUser?.isAuthority) return; const issues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]'); const verified = issues.filter(i => i.votes.yes >= 3);
      const pending = verified.filter(i => i.status === 'verified' || i.status === 'pending').length; const prog = verified.filter(i => i.status === 'in-progress').length; const res = verified.filter(i => i.status === 'resolved').length;
      document.getElementById('pendingIssues').textContent = pending; document.getElementById('inProgressIssues').textContent = prog; document.getElementById('resolvedIssues').textContent = res;
      const list = document.getElementById('authorityIssuesList'); list.innerHTML = '';
      verified.forEach(issue => { const el = document.createElement('div'); el.className = 'issue-item'; el.innerHTML = `
        <div class="issue-header"><h4>${issue.category}</h4><span class="issue-status status-${issue.status}">${issue.status}</span></div>
        <p>${issue.description}</p><p><strong>Location:</strong> ${issue.location.latitude.toFixed(4)}, ${issue.location.longitude.toFixed(4)}</p>
        <p><strong>Reported by:</strong> ${issue.reporterName}</p><p><strong>Community Votes:</strong> 👍 ${issue.votes.yes} 👎 ${issue.votes.no}</p>
        <div class="issue-actions">
          ${(issue.status === 'pending' || issue.status === 'verified') ? `<button class="btn-primary" onclick="updateIssueStatus('${issue.id}', 'in-progress')">Mark In Progress</button>` : ''}
          ${issue.status === 'in-progress' ? `<button class="btn-secondary" onclick="updateIssueStatus('${issue.id}', 'resolved')">Mark Resolved</button>` : ''}
        </div>`; list.appendChild(el); });
    }

    function updateIssueStatus(id, status) {
      const issues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]'); const idx = issues.findIndex(i => i.id === id); if (idx === -1) return;
      issues[idx].status = status; issues[idx].lastUpdated = new Date().toISOString(); issues[idx].updatedBy = currentUser.id; localStorage.setItem('smartcitizen_issues', JSON.stringify(issues));
      if (status === 'resolved') showNotification('Issue has been marked as resolved. All users will be notified.');
      loadAuthorityDashboard(); updateStats(); if (mainMap) refreshMap();
    }

    // Utils
    function updateStats() {
      const issues = JSON.parse(localStorage.getItem('smartcitizen_issues') || '[]');
      const users = JSON.parse(localStorage.getItem('smartcitizen_users') || '[]');
      document.getElementById('totalReports').textContent = issues.length;
      document.getElementById('resolvedReports').textContent = issues.filter(i => i.status === 'resolved').length;
      document.getElementById('activeUsers').textContent = users.length || 1;
    }

    function showNotification(msg, type = 'success') {
      const c = document.getElementById('notificationContainer'); const n = document.createElement('div'); n.className = `notification ${type}`; n.textContent = msg; c.appendChild(n); setTimeout(() => n.remove(), 5000);
    }

    function setupMapInitialization() {
      const observer = new MutationObserver((mut) => {
        mut.forEach(m => { if (m.type === 'attributes' && m.attributeName === 'class') { const t = m.target; if (t.classList.contains('active')) { if (t.id === 'map' && !mainMap) setTimeout(initializeMainMap, 100); if (t.id === 'report' && !locationMap) setTimeout(initializeLocationMap, 100); } } });
      });
      document.querySelectorAll('.section').forEach(s => observer.observe(s, { attributes: true }));
    }

    // Demo data
    function generateDemoData() {
      // demo users with varying badges and points for leaderboard
      const demoUsers = [
        { id: 'SC_DEMO_AUTH', name: 'Authority Demo', email: 'authority@demo.com', phone: '+919999999999', password: 'demo123', isAuthority: true, reputationPoints: 0, badges: [], joinDate: new Date().toISOString() },
        { id: 'SC_DEMO_U1', name: 'Aarya Verma', email: 'aarya@demo.com', phone: '+911111111111', password: 'demo123', isAuthority: false, reputationPoints: 120, badges: [b('reporter'), b('voter'), b('active')], joinDate: isoDaysAgo(40) },
        { id: 'SC_DEMO_U2', name: 'Rohit Kumar', email: 'rohit@demo.com', phone: '+912222222222', password: 'demo123', isAuthority: false, reputationPoints: 90, badges: [b('reporter'), b('voter')], joinDate: isoDaysAgo(25) },
        { id: 'SC_DEMO_U3', name: 'Neha Singh', email: 'neha@demo.com', phone: '+913333333333', password: 'demo123', isAuthority: false, reputationPoints: 200, badges: [b('reporter'), b('voter'), b('active'), b('expert')], joinDate: isoDaysAgo(60) },
        { id: 'SC_DEMO_U4', name: 'Imran Ali', email: 'imran@demo.com', phone: '+914444444444', password: 'demo123', isAuthority: false, reputationPoints: 45, badges: [b('reporter')], joinDate: isoDaysAgo(10) },
        { id: 'SC_DEMO_U5', name: 'Priya Patel', email: 'priya@demo.com', phone: '+915555555555', password: 'demo123', isAuthority: false, reputationPoints: 160, badges: [b('reporter'), b('voter'), b('active')], joinDate: isoDaysAgo(30) }
      ];
      localStorage.setItem('smartcitizen_users', JSON.stringify(demoUsers));
      const demoIssues = [{ id: 'ISSUE_DEMO_1', category: 'road', description: 'सड़क में बड़े गड्ढे हैं जो यातायात में समस्या पैदा कर रहे हैं', location: { latitude: 28.6139, longitude: 77.2090 }, reporterId: 'SC_DEMO_U3', reporterName: 'Neha Singh', timestamp: new Date(Date.now() - 86400000).toISOString(), status: 'pending', votes: { yes: 5, no: 0, voters: ['user1','user2','user3','user4','user5'] } }];
      localStorage.setItem('smartcitizen_issues', JSON.stringify(demoIssues));
    }

    function b(type) {
      const types = { reporter: { name: 'First Reporter', icon: 'fas fa-flag' }, voter: { name: 'Community Voter', icon: 'fas fa-vote-yea' }, active: { name: 'Active Citizen', icon: 'fas fa-star' }, expert: { name: 'Civic Expert', icon: 'fas fa-trophy' } };
      const t = types[type] || types.reporter;
      return { type, name: t.name, icon: t.icon, earnedDate: new Date().toISOString() };
    }

    function isoDaysAgo(n){ const d = new Date(); d.setDate(d.getDate()-n); return d.toISOString(); }

    // Close modals on outside click
    window.onclick = function(e) { document.querySelectorAll('.modal').forEach(m => { if (e.target === m) m.style.display = 'none'; }); };
  </script>
</body>
</html>
